name: Auto-merge claude branches to main

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed
    branches:
      - 'claude/**'

jobs:
  auto-merge:
    name: Merge into main (after CI passes)
    runs-on: ubuntu-latest
    # Only proceed when CI passed and the branch is a claude/* branch
    if: github.event.workflow_run.conclusion == 'success' && startsWith(github.event.workflow_run.head_branch, 'claude/')
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Merge into main
        id: merge
        continue-on-error: true
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          git fetch origin "$BRANCH"
          git checkout main
          git pull origin main
          git merge --no-ff "origin/$BRANCH" -m "Auto-merge $BRANCH into main (CI passed)"
          git push origin main

      - name: Create issue on merge failure
        if: steps.merge.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ github.event.workflow_run.head_branch }}';
            const runUrl = '${{ github.event.workflow_run.html_url }}';
            
            const body = [
              '## Auto-merge Failed',
              '',
              `The auto-merge workflow failed to merge branch \`${branch}\` into \`main\`.`,
              '',
              '### Possible Reasons',
              '- Merge conflicts with the main branch',
              '- Branch protection rules prevented the push',
              '- Network or temporary GitHub API issues',
              '',
              '### Next Steps',
              `1. Review the [workflow run logs](${runUrl}) for details`,
              `2. Check for merge conflicts: \`git checkout main && git pull && git merge origin/${branch}\``,
              '3. Resolve any conflicts manually and merge the branch',
              `4. Consider rebasing \`${branch}\` on the latest \`main\` if appropriate`,
              '',
              '### Related Resources',
              `- Branch: \`${branch}\``,
              `- CI Run: ${runUrl}`,
              '',
              '_This issue was automatically created by the auto-merge workflow._',
            ].join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Auto-merge failed: ${branch} â†’ main`,
              body: body,
              labels: ['automation', 'needs-attention'],
            });

      - name: Fail workflow if merge failed
        if: steps.merge.outcome == 'failure'
        run: |
          echo "::error::Auto-merge failed. An issue has been created to track this failure."
          exit 1
